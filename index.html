<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVからColor Map New</title>
    <style>
        table {
            border-collapse: collapse;
        }

        table, th, td {
            border: 0.5px solid black;
            padding: 5px;
        }

        .color-input {
            margin: 2px;
        }

        .large-button {
            font-size: 20px;
            padding: 10px 20px;
            margin: 10px;
        }

        #colorMapContainer {
            width: 100%;
            max-height: 400px;
            overflow: auto;
            border: 1px solid #000;
        }

        #colorMap {
            width: 100%;
            height: auto;
        }

        .fullscreen-table {
            width: 100%;
            height: 100%;
            max-height: none;
            overflow: visible;
        }

        /* 矢印描画用のcanvas */
        #arrowCanvas {
            position: absolute;
            pointer-events: none;
            z-index: 10; /* テーブルの上に表示 */
        }
    </style>
</head>
<body>
    <input type="file" id="fileInput" accept=".csv">
    <div>
        <label for="minValue">最小値 : </label>
        <input type="number" id="minValue" value="0">
        <label for="maxValue">最大値 : </label>
        <input type="number" id="maxValue" value="100">
    </div>
    <div id="colorSelectors">
        <div class="color-input">
            <label> 1% - 10%  : <input type="number" id="range1" value="10" min="1" max="100"> <input type="color" id="color1" value="#ff2e2e"></label>
        </div>
        <div class="color-input">
            <label>11% - 20%  : <input type="number" id="range2" value="20" min="1" max="100"> <input type="color" id="color2" value="#f9b030"></label>
        </div>
        <div class="color-input">
            <label>21% - 30%  : <input type="number" id="range3" value="30" min="1" max="100"> <input type="color" id="color3" value="#fcff33"></label>
        </div>
        <div class="color-input">
            <label>31% - 40%  : <input type="number" id="range4" value="40" min="1" max="100"> <input type="color" id="color4" value="#87fb28"></label>
        </div>
        <div class="color-input">
            <label>41% - 50%  : <input type="number" id="range5" value="50" min="1" max="100"> <input type="color" id="color5" value="#00db04"></label>
        </div>
        <div class="color-input">
            <label>51% - 60%  : <input type="number" id="range6" value="60" min="1" max="100"> <input type="color" id="color6" value="#2effaf"></label>
        </div>
        <div class="color-input">
            <label>61% - 70%  : <input type="number" id="range7" value="70" min="1" max="100"> <input type="color" id="color7" value="#13ecdd"></label>
        </div>
        <div class="color-input">
            <label>71% - 80%  : <input type="number" id="range8" value="80" min="1" max="100"> <input type="color" id="color8" value="#0084ff"></label>
        </div>
        <div class="color-input">
            <label>81% - 90%  : <input type="number" id="range9" value="90" min="1" max="100"> <input type="color" id="color9" value="#0062ff"></label>
        </div>
        <div class="color-input">
            <label>91% - 100%: <input type="number" id="range10" value="100" min="1" max="100"> <input type="color" id="color10" value="#0000ff"></label>
        </div>
    </div>
    <button id="updateButton" class="large-button">カラーマップを更新</button>
    <button id="applyButton" class="large-button">適用</button>
    <button id="fullscreenButton" class="large-button">全体図を表示</button>

    <div id="colorMapContainer">
        <div id="colorMap"></div>
    </div>

    <!-- 矢印を描画するcanvas -->
    <canvas id="arrowCanvas"></canvas>

    <!-- html2canvasライブラリの追加 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        let globalData = null;
        let autoMinValue = Number.POSITIVE_INFINITY;
        let autoMaxValue = Number.NEGATIVE_INFINITY;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.readAsText(file);

            reader.onload = function() {
                globalData = reader.result;
                calculateMinMax();
                updateColorMap();
            };
        });

        document.getElementById('fullscreenButton').addEventListener('click', function() {
            const newWindow = window.open('', '', 'width=800,height=600');
            newWindow.document.write('<html><head><title>全体図</title></head><body></body></html>');
            const colorMapContainer = newWindow.document.body;
            const tableContainer = document.getElementById('colorMap').cloneNode(true);
            colorMapContainer.appendChild(tableContainer);
            const table = colorMapContainer.querySelector('table');
            table.style.transform = 'scale(0.1)';
            table.style.transformOrigin = 'top left';
            colorMapContainer.style.overflow = 'auto';
            newWindow.document.close();
        });

        document.getElementById('updateButton').addEventListener('click', function() {
            updateColorMap();
            drawArrowToMinValueCell();
        });

        document.getElementById('applyButton').addEventListener('click', function() {
            const table = document.querySelector('table');
            if (table) {
                table.style.fontSize = '12px';
            }
        });

        function calculateMinMax() {
            if (!globalData) return;

            const lines = globalData.split('\n');
            for (let i = 1; i < lines.length; i++) {
                const rowData = lines[i].split(',');
                rowData.forEach(cell => {
                    const numericValue = parseFloat(cell);
                    if (!isNaN(numericValue)) {
                        if (numericValue < autoMinValue) autoMinValue = numericValue;
                        if (numericValue > autoMaxValue) autoMaxValue = numericValue;
                    }
                });
            }

            document.getElementById('minValue').value = autoMinValue;
            document.getElementById('maxValue').value = autoMaxValue;
        }

        function updateColorMap() {
            if (!globalData) return;

            const minValue = parseFloat(document.getElementById('minValue').value);
            const maxValue = parseFloat(document.getElementById('maxValue').value);

            const lines = globalData.split('\n');
            const headers = lines[0].split(',');
            const colorMap = document.getElementById('colorMap');
            colorMap.innerHTML = '';

            const table = document.createElement('table');
            const headerRow = document.createElement('tr');

            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });

            table.appendChild(headerRow);

            for (let i = 1; i < lines.length; i++) {
                const rowData = lines[i].split(',');
                const row = document.createElement('tr');
                rowData.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    const numericValue = parseFloat(cell);
                    if (!isNaN(numericValue)) {
                        td.style.backgroundColor = getColorForValue(numericValue, minValue, maxValue);
                    }
                    row.appendChild(td);
                });
                table.appendChild(row);
            }

            colorMap.appendChild(table);
        }

        function getColorForValue(value, min, max) {
            const ranges = [
                parseFloat(document.getElementById('range1').value),
                parseFloat(document.getElementById('range2').value),
                parseFloat(document.getElementById('range3').value),
                parseFloat(document.getElementById('range4').value),
                parseFloat(document.getElementById('range5').value),
                parseFloat(document.getElementById('range6').value),
                parseFloat(document.getElementById('range7').value),
                parseFloat(document.getElementById('range8').value),
                parseFloat(document.getElementById('range9').value),
                parseFloat(document.getElementById('range10').value),
            ];

            const colors = [
                document.getElementById('color1').value,
                document.getElementById('color2').value,
                document.getElementById('color3').value,
                document.getElementById('color4').value,
                document.getElementById('color5').value,
                document.getElementById('color6').value,
                document.getElementById('color7').value,
                document.getElementById('color8').value,
                document.getElementById('color9').value,
                document.getElementById('color10').value,
            ];

            const percentage = ((value - min) / (max - min)) * 100;

            for (let i = 0; i < ranges.length; i++) {
                if (percentage <= ranges[i]) {
                    return colors[i];
                }
            }
            return '#ffffff'; // デフォルトの背景色（白）
        }

        function drawArrowToMinValueCell() {
            const table = document.querySelector('table');
            const rows = table.getElementsByTagName('tr');
            let minCell = null;
            let minRowIndex = 0;
            let minColIndex = 0;

            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                for (let j = 0; j < cells.length; j++) {
                    const value = parseFloat(cells[j].textContent);
                    if (!isNaN(value) && value === autoMinValue) {
                        minCell = cells[j];
                        minRowIndex = i;
                        minColIndex = j;
                        break;
                    }
                }
                if (minCell) break;
            }

            if (minCell) {
                const canvas = document.getElementById('arrowCanvas');
                const context = canvas.getContext('2d');

                const rect = table.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                canvas.style.left = `${rect.left}px`;
                canvas.style.top = `${rect.top}px`;

                const cellRect = minCell.getBoundingClientRect();
                const cellCenterX = cellRect.left + (cellRect.width / 2) - rect.left;
                const cellCenterY = cellRect.top + (cellRect.height / 2) - rect.top;

                context.clearRect(0, 0, canvas.width, canvas.height);
                context.strokeStyle = 'red';
                context.lineWidth = 2;

                context.beginPath();
                context.moveTo(cellCenterX, 0); 
                context.lineTo(cellCenterX, cellCenterY);
                context.stroke();

                context.beginPath();
                context.moveTo(cellCenterX - 5, cellCenterY - 10);
                context.lineTo(cellCenterX, cellCenterY);
                context.lineTo(cellCenterX + 5, cellCenterY - 10);
                context.stroke();
            }
        }
    </script>
</body>
</html>
